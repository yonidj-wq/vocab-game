<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>English Practice Game</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin:0; background:#f6f7fb; color:#111; }
    header { background:#111827; color:#fff; padding:14px 16px; }
    header h1 { margin:0; font-size:18px; }
    header p { margin:6px 0 0; opacity:.9; font-size:13px; }

    main { padding:14px; max-width: 980px; margin: 0 auto; }

    .card {
      background:#fff; border:1px solid #e5e7eb; border-radius:16px; padding:14px; margin-bottom:12px;
      box-shadow: 0 1px 0 rgba(0,0,0,.02);
    }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .row > * { flex: 1 1 auto; }

    .muted { color:#6b7280; font-size:13px; }
    .btn {
      border:1px solid #d1d5db; background:#fff; padding:10px 12px; border-radius:12px;
      cursor:pointer; font-weight:900;
    }
    .btn.primary { background:#2563eb; border-color:#2563eb; color:#fff; }
    .btn.good { background:#16a34a; border-color:#16a34a; color:#fff; }
    .btn.warn { background:#f59e0b; border-color:#f59e0b; color:#111; }
    .btn:disabled { opacity:.55; cursor:not-allowed; }

    select, input[type="number"] {
      width:100%; padding:10px 12px; border-radius:12px; border:1px solid #d1d5db; background:#fff;
      font-size:15px;
    }

    .pill { display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px; background:#f3f4f6; border:1px solid #e5e7eb; }
    .listenBtn { padding:8px 10px; border-radius:999px; border:1px solid #d1d5db; background:#fff; cursor:pointer; font-weight:900; }
    .hr { height:1px; background:#e5e7eb; margin:12px 0; }

    .bigTitle { display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .bigTitle h2 { margin:0; font-size:16px; }
    .bigTitle .muted { margin:0; }

    .task {
      border:1px solid #e5e7eb; border-radius:16px; padding:14px; background:#fff;
      display:flex; flex-direction:column; gap:10px;
    }
    .task .prompt { font-weight:900; font-size:16px; }
    .task .sub { color:#6b7280; font-size:13px; }
    .answers { display:flex; gap:10px; flex-wrap:wrap; }
    .answers label {
      border:1px solid #e5e7eb; background:#fff; padding:10px 12px; border-radius:12px; cursor:pointer;
      display:flex; gap:8px; align-items:center;
    }
    .answers input[type="radio"] { transform: scale(1.1); }
    .feedback { padding:10px 12px; border-radius:12px; border:1px solid #e5e7eb; background:#f9fafb; }
    .feedback.good { border-color:#16a34a55; background:#16a34a10; }
    .feedback.bad  { border-color:#ef444455; background:#ef444410; }

    .readingBox {
      background:#fff; border:1px solid #e5e7eb; border-radius:16px; padding:14px; line-height:1.55;
      direction:ltr; white-space:pre-wrap;
    }

    .grid {
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap:12px;
    }
    .flashcard {
      border:1px solid #e5e7eb; border-radius:16px; padding:14px; background:#fff;
      text-align:center; cursor:pointer;
      min-height: 105px;
      display:flex; flex-direction:column; justify-content:center; gap:10px;
      font-weight:900;
    }
    .flashcard .back { color:#111; font-weight:800; }
    .tag {
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid #e5e7eb;
      background:#f3f4f6;
      font-size:12px;
      color:#374151;
    }

    /* confetti */
    .confetti { position: fixed; inset: 0; pointer-events:none; overflow:hidden; z-index: 9999; }
    .confetti i { position:absolute; top:-20px; width:10px; height:14px; border-radius:3px; opacity:.9; animation: fall 900ms linear forwards; }
    @keyframes fall { to { transform: translateY(110vh) rotate(360deg); opacity: 0.9; } }

    @media (max-width: 720px) {
      .row { align-items:stretch; }
    }
  </style>
</head>

<body>
<header>
  <h1>××©×—×§ ×× ×’×œ×™×ª - ×”×›× ×” ×œ××‘×—×Ÿ</h1>
  <p>×œ×—×¦×• ğŸ”Š ×›×“×™ ×œ×©××•×¢. ×‘××™×™×¤×•×Ÿ ×—×™×™×‘×™× ×œ×œ×—×•×¥ ×¤×¢× ××—×ª ×¢×œ ğŸ”Š ×›×“×™ ×©×”×§×•×œ ×™×ª×—×™×œ.</p>
</header>

<main>
  <div class="card">
    <div class="bigTitle">
      <h2>×”×’×“×¨×•×ª</h2>
      <p class="muted">×¨×¢× ×•×Ÿ ×™×’×¨×™×œ ××©×™××•×ª ×—×“×©×•×ª</p>
    </div>

    <div class="hr"></div>

    <div class="row">
      <div>
        <div class="muted">×‘×—×¨ ×¡×˜ (Deck)</div>
        <select id="deckSelect"></select>
      </div>

      <div>
        <div class="muted">×›××•×ª ××©×™××•×ª ×‘××©×—×§</div>
        <input id="taskCount" type="number" min="6" max="30" value="14" />
      </div>

      <div style="min-width: 210px;">
        <div class="muted">Voice (English)</div>
        <select id="voiceSelect"></select>
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <button class="btn warn" id="refreshBtn">×¨×¢× ×Ÿ (×”×’×¨×œ×” ×—×“×©×”)</button>
      <button class="btn primary" id="startBtn">×”×ª×—×œ ××©×—×§</button>
      <button class="btn" id="resetBtn">××™×¤×•×¡ × ×™×§×•×“</button>
    </div>

    <div class="hr"></div>

    <div class="row">
      <span class="pill"><b>× ×™×§×•×“</b> <span id="score">0</span></span>
      <span class="pill"><b>×¨×¦×£ × ×›×•×Ÿ</b> <span id="streak">0</span></span>
      <span class="pill"><b>×›×•×›×‘×™×</b> <span id="stars">0</span> â­</span>
      <span class="pill"><b>××©×™××”</b> <span id="progress">0</span></span>
      <span class="pill"><b>××¦×‘</b> <span id="modeLabel">â€”</span></span>
    </div>
  </div>

  <div class="card">
    <div class="bigTitle">
      <h2>×›×¨×˜×™×¡×™×•×ª ××™×œ×™× (×ª×¨×’×•×œ ×—×•×¤×©×™)</h2>
      <p class="muted">×œ×—×¦×• ×¢×œ ×›×¨×˜×™×¡ ×›×“×™ ×œ×¨××•×ª ×¤×™×¨×•×©</p>
    </div>
    <div class="hr"></div>
    <div class="row" style="margin-bottom:10px;">
      <button class="btn" id="newCardsBtn">×”×’×¨×œ ×›×¨×˜×™×¡×™×•×ª ×—×“×©×•×ª</button>
      <span class="muted">××•××œ×¥ ×œ×¤× ×™ ××‘×—×Ÿ: 2â€“3 ×¡×‘×‘×™×</span>
    </div>
    <div id="flashHost" class="grid"></div>
  </div>

  <div id="gameArea" class="card">
    <div class="bigTitle">
      <h2>×”××©×—×§</h2>
      <p class="muted">×œ×—×¦×• "×”×ª×—×œ ××©×—×§"</p>
    </div>
    <div class="hr"></div>
    <div id="taskHost"></div>
  </div>
</main>

<div id="confetti" class="confetti" hidden></div>

<script>
/* =========================
   DATA: ×¨×§ ×›××Ÿ ××¢×“×›× ×™×
   ========================= */
const DATA = {
  settings: {
    defaultVoiceLang: "en-US",
    speechRate: 0.95,
    speechPitch: 1.0,
    speechVolume: 1.0,
    flashcardCount: 18,
    ensureReadingInGame: true,  // ×ª××™×“ ×™×›× ×™×¡ ×œ×¤×—×•×ª ××©×™××ª ×§×¨×™××” ××—×ª ×× ×™×© ×§×˜×¢×™×
    ensureListeningInGame: true // ×ª××™×“ ×™×›× ×™×¡ ×œ×¤×—×•×ª ××©×™××ª ×”××–× ×” ××—×ª ×× ×™×©
  },

  decks: [
    {
      id: "unit2_main",
      name: "Unit 2 + ××™×œ×™× ×—×“×©×•×ª + ×™×—×™×“/×¨×‘×™×",
      vocab: [
        // Unit 2 (××”×“×¤×™× ×”×§×•×“××™×)
        { en:"something", he:"××©×”×•" },
        { en:"sick", he:"×—×•×œ×”" },
        { en:"plate", he:"×¦×œ×—×ª" },
        { en:"road", he:"×›×‘×™×© / ×“×¨×š" },
        { en:"again", he:"×©×•×‘" },
        { en:"think", he:"×œ×—×©×•×‘" },
        { en:"club", he:"××•×¢×“×•×Ÿ / ×—×•×’" },
        { en:"true", he:"× ×›×•×Ÿ / ×××ª" },
        { en:"fix", he:"×œ×ª×§×Ÿ" },
        { en:"way", he:"×“×¨×š" },

        { en:"later", he:"××—×¨ ×›×š / ×××•×—×¨ ×™×•×ª×¨" },
        { en:"clock", he:"×©×¢×•×Ÿ" },
        { en:"adult", he:"××‘×•×’×¨" },
        { en:"winner", he:"×× ×¦×—" },
        { en:"artist", he:"×××Ÿ / ×¦×™×™×¨" },

        { en:"hurt", he:"×›×•××‘ / ×œ×¤×¦×•×¢" },
        { en:"build", he:"×œ×‘× ×•×ª" },
        { en:"wait", he:"×œ×—×›×•×ª" },
        { en:"more", he:"×¢×•×“ / ×™×•×ª×¨" },
        { en:"a quarter to", he:"×¨×‘×¢ ×œ-" },

        // ××™×œ×™× ×—×“×©×•×ª ××”×ª××•× ×•×ª
        { en:"shelf", he:"××“×£" },
        { en:"peach", he:"××¤×¨×¡×§" },
        { en:"pepper", he:"×¤×œ×¤×œ" },
        { en:"baby", he:"×ª×™× ×•×§" },
        { en:"box", he:"×§×•×¤×¡×”" },
        { en:"dress", he:"×©××œ×”" },
        { en:"tomato", he:"×¢×’×‘× ×™×”" },
        { en:"dessert", he:"×§×™× ×•×—" },
        { en:"carrot", he:"×’×–×¨" },
        { en:"foot", he:"×›×£ ×¨×’×œ" },
        { en:"sandwich", he:"×›×¨×™×š" },
        { en:"candy", he:"×××ª×§" },
        { en:"onion", he:"×‘×¦×œ" },
        { en:"wolf", he:"×–××‘" },
        { en:"fox", he:"×©×•×¢×œ" },
        { en:"knife", he:"×¡×›×™×Ÿ" },
        { en:"potato", he:"×ª×¤×•×— ××“××”" },
        { en:"sheep", he:"×›×‘×©×”" },
        { en:"table", he:"×©×•×œ×—×Ÿ" },
        { en:"class", he:"×›×™×ª×”" },
        { en:"day", he:"×™×•×" },
        { en:"leaf", he:"×¢×œ×”" },
        { en:"city", he:"×¢×™×¨" },
        { en:"man", he:"×’×‘×¨" },
        { en:"men", he:"×’×‘×¨×™×" },
        { en:"hero", he:"×’×™×‘×•×¨" },
        { en:"story", he:"×¡×™×¤×•×¨" },
        { en:"house", he:"×‘×™×ª" },
        { en:"child", he:"×™×œ×“" },
        { en:"children", he:"×™×œ×“×™×" },
        { en:"mouse", he:"×¢×›×‘×¨" },
        { en:"monkey", he:"×§×•×£" },
        { en:"party", he:"××¡×™×‘×”" },
        { en:"vegetables", he:"×™×¨×§×•×ª" },
        { en:"idea", he:"×¨×¢×™×•×Ÿ" },
      ],

      plurals: [
        { s:"onion", p:"onions" },
        { s:"wolf", p:"wolves" },
        { s:"fox", p:"foxes" },
        { s:"girl", p:"girls" },
        { s:"knife", p:"knives" },
        { s:"shelf", p:"shelves" },
        { s:"potato", p:"potatoes" },
        { s:"sheep", p:"sheep" },
        { s:"table", p:"tables" },
        { s:"class", p:"classes" },
        { s:"day", p:"days" },
        { s:"leaf", p:"leaves" },
        { s:"sandwich", p:"sandwiches" },
        { s:"city", p:"cities" },
        { s:"man", p:"men" },
        { s:"hero", p:"heroes" },
        { s:"story", p:"stories" },
        { s:"foot", p:"feet" },
        { s:"house", p:"houses" },
        { s:"dress", p:"dresses" },
        { s:"child", p:"children" },
        { s:"mouse", p:"mice" },
        { s:"monkey", p:"monkeys" },
        { s:"party", p:"parties" },
      ],

      fill: [
        { template:"Some people like to drink cola with ___.", choices:["ice","boots","plate","club"], answer:"ice" },
        { template:"He was the first in the ___.", choices:["race","clock","sign","road"], answer:"race" },
        { template:"We want to go to our neighbors ___.", choices:["later","again","tired","winner"], answer:"later" },
        { template:"I always ___ at a quarter to seven.", choices:["get up","build","paint","wait"], answer:"get up" },
        { template:"I was in Canada two years ___.", choices:["ago","more","cold","true"], answer:"ago" },
        { template:"The ___ painted pictures on the walls.", choices:["artist","adult","penguin","winner"], answer:"artist" },
        { template:"There ___ five clocks in my house.", choices:["is","are"], answer:"are" },
        { template:"Rami ___ a green bag.", choices:["have","has"], answer:"has" },
      ],

      yesno: [
        { statement:"The girls learn about the new clubs from a sign.", answer:true },
        { statement:"The LEGO robotics club meets on Thursdays.", answer:false },
        { statement:"The judo club meets at a quarter to five.", answer:true },
        { statement:"Pam wants to do more sports.", answer:false },

        { statement:"The Blue Birds are a basketball team.", answer:true },
        { statement:"The Blue Birds practice for one hour every day.", answer:false }, // ×‘×˜×§×¡×˜ ×›×ª×•×‘ two hours
        { statement:"The doctor says Zack canâ€™t play basketball for a month.", answer:true },
        { statement:"Zack helped the Blue Birds win many games.", answer:true },
      ],

      listeningSets: [
        {
          title: "Listening: Clubs",
          text:
            "Robin and Pam see a sign about new clubs. The art club is on Tuesdays. The judo club is at a quarter to five. Pam is scared of dogs, so she doesnâ€™t want the Little Vets club. In the end, the girls choose the judo club.",
          questions: [
            {
              prompt: "On Tuesdays, Robin â€¦",
              choices: [
                "has dance lessons",
                "paints pictures at the art club",
                "plays with a little boy",
                "goes to a club with her neighbor"
              ],
              answerIndex: 1
            },
            {
              prompt: "Pam doesnâ€™t want to go to the Little Vets club because â€¦",
              choices: [
                "she swims on the day the Little Vets meet",
                "the animals are dirty",
                "the art club meets at the same time",
                "sheâ€™s scared of dogs"
              ],
              answerIndex: 3
            },
            {
              prompt: "In the end, the girls â€¦",
              choices: [
                "choose the judo club",
                "donâ€™t go to a new club",
                "go to the art club",
                "want to swim together"
              ],
              answerIndex: 0
            }
          ]
        }
      ],

      readingSets: [
        {
          title: "Reading: Zack and the Blue Birds",
          text:
`Zack is a basketball player. He plays with a team called the Blue Birds. They practice for two hours every day at the park.

Zackâ€™s team is very good. They win lots of games.

Zackâ€™s team has an important game today. The players are excited. But Zack isnâ€™t excited. He canâ€™t play in the game. He has a problem with his arm. It hurts when he moves it. The doctor says he canâ€™t play basketball for a month.

Zack goes to the game, but he doesnâ€™t play. He has a big sign with his teamâ€™s name. He watches his friends in the game. They run and throw the ball. Zack is sad. Itâ€™s hard to watch the game. Zack wants to play too.

After two hours, the Blue Birds win the game. The players get medals. Zack gets a medal too because he helped them win lots of games. Now heâ€™s happy. He canâ€™t wait to play basketball again in a month.`,
          questions: [
            { prompt:"Zack isnâ€™t playing in the game because â€¦", choices:["he doesnâ€™t practice","he is in a race","his arm hurts","he isnâ€™t a good player"], answerIndex:2 },
            { prompt:"At the game, Zack â€¦", choices:["throws the ball","feels excited","makes a sign","watches the players"], answerIndex:3 },
            { prompt:"Zack is happy after the game because â€¦", choices:["he gets a medal","he can play basketball again","his arm doesnâ€™t hurt","everyone likes his sign"], answerIndex:0 },
            { prompt:"A good name for this story is â€¦", choices:["Zack Wins a Basketball Game","Zackâ€™s Problem","A Sign for Zack","Zackâ€™s Friends"], answerIndex:1 },
          ]
        }
      ]
    },

    // ×¡×˜ ×§×˜×Ÿ ×™×•×ª×¨ ×œ×“×•×’××”
    {
      id: "unit2_quick",
      name: "×—×–×¨×” ×§×¦×¨×” (××”×™×¨)",
      vocab: [
        { en:"club", he:"××•×¢×“×•×Ÿ / ×—×•×’" },
        { en:"sign", he:"×©×œ×˜" },
        { en:"artist", he:"×××Ÿ / ×¦×™×™×¨" },
        { en:"winner", he:"×× ×¦×—" },
        { en:"a quarter to", he:"×¨×‘×¢ ×œ-" },
        { en:"hurt", he:"×›×•××‘" },
        { en:"ice", he:"×§×¨×—" },
        { en:"boots", he:"××’×¤×™×™×" },
        { en:"snowman", he:"××™×© ×©×œ×’" },
        { en:"weather", he:"××–×’ ××•×•×™×¨" }
      ],
      plurals: [
        { s:"city", p:"cities" },
        { s:"party", p:"parties" },
        { s:"knife", p:"knives" },
        { s:"wolf", p:"wolves" },
      ],
      fill: [
        { template:"Be careful on the ___.", choices:["ice","club","road"], answer:"ice" },
        { template:"The ___ painted pictures.", choices:["artist","winner","clock"], answer:"artist" },
        { template:"I will see you ___.", choices:["later","plate","sick"], answer:"later" }
      ],
      yesno: [
        { statement:"A snowman is made of snow.", answer:true },
        { statement:"A penguin can fly.", answer:false }
      ],
      listeningSets: [],
      readingSets: []
    }
  ]
};

/* =========================
   Speech (Audio)
   ========================= */
let chosenVoiceURI = "";
function getVoices() { return window.speechSynthesis?.getVoices?.() || []; }

function populateVoices() {
  const sel = document.getElementById("voiceSelect");
  sel.innerHTML = "";
  const voices = getVoices();
  const english = voices.filter(v => (v.lang || "").toLowerCase().startsWith("en"));
  const list = english.length ? english : voices;

  list.forEach(v => {
    const opt = document.createElement("option");
    opt.value = v.voiceURI;
    opt.textContent = `${v.name} (${v.lang})`;
    sel.appendChild(opt);
  });

  const preferred = list.find(v => (v.lang || "").toLowerCase() === DATA.settings.defaultVoiceLang.toLowerCase());
  const fallback = preferred || list[0];
  if (fallback) {
    sel.value = fallback.voiceURI;
    chosenVoiceURI = fallback.voiceURI;
  }

  sel.onchange = () => chosenVoiceURI = sel.value;
}

function pickVoice() {
  const voices = getVoices();
  if (!voices.length) return null;
  if (chosenVoiceURI) return voices.find(v => v.voiceURI === chosenVoiceURI) || null;
  return voices[0] || null;
}

function speak(text) {
  if (!("speechSynthesis" in window)) { alert("××™×Ÿ ×ª××™×›×” ×‘×”×©××¢×” ×‘×“×¤×“×¤×Ÿ ×”×–×”."); return; }
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.rate = DATA.settings.speechRate;
  u.pitch = DATA.settings.speechPitch;
  u.volume = DATA.settings.speechVolume;
  const v = pickVoice();
  if (v) { u.voice = v; u.lang = v.lang; }
  window.speechSynthesis.speak(u);
}

if ("speechSynthesis" in window) {
  window.speechSynthesis.onvoiceschanged = populateVoices;
  setTimeout(populateVoices, 250);
}

/* =========================
   State + Utils
   ========================= */
const KEY = "english_game_clean_v1";
let state = {
  deckId: DATA.decks[0].id,
  seed: Date.now(),
  score: 0,
  streak: 0,
  stars: 0,
  game: { tasks: [], index: 0, mode: "â€”" },
  flashSeed: Date.now()
};

function loadState() {
  try {
    const raw = localStorage.getItem(KEY);
    if (raw) state = Object.assign(state, JSON.parse(raw));
  } catch {}
}
function saveState() {
  localStorage.setItem(KEY, JSON.stringify(state));
  renderTop();
}
function getDeck() {
  return DATA.decks.find(d => d.id === state.deckId) || DATA.decks[0];
}

function el(tag, attrs={}, children=[]) {
  const node = document.createElement(tag);
  for (const [k,v] of Object.entries(attrs)) {
    if (k === "class") node.className = v;
    else if (k === "html") node.innerHTML = v;
    else if (k.startsWith("on") && typeof v === "function") node.addEventListener(k.slice(2), v);
    else node.setAttribute(k, v);
  }
  for (const c of children) node.appendChild(typeof c === "string" ? document.createTextNode(c) : c);
  return node;
}

function prng(seed) {
  let s = seed >>> 0;
  return () => ((s = (s * 1664525 + 1013904223) >>> 0) / 4294967296);
}
function shuffle(arr, seed) {
  const a = arr.slice();
  const rnd = prng(seed);
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(rnd() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}
function sample(arr, n, seed) {
  return shuffle(arr, seed).slice(0, Math.min(n, arr.length));
}

function listenBtn(text, label="ğŸ”Š") {
  return el("button", { class:"listenBtn", type:"button", onclick: () => speak(text) }, [label]);
}

function feedback(msg, ok) {
  return el("div", { class: "feedback " + (ok ? "good":"bad") }, [msg]);
}

/* =========================
   Confetti
   ========================= */
function popConfetti() {
  const box = document.getElementById("confetti");
  box.innerHTML = "";
  box.hidden = false;
  const colors = ["#2563eb","#16a34a","#f59e0b","#ef4444","#8b5cf6"];
  for (let i = 0; i < 24; i++) {
    const piece = document.createElement("i");
    piece.style.left = Math.floor(Math.random()*100) + "vw";
    piece.style.background = colors[Math.floor(Math.random()*colors.length)];
    piece.style.animationDuration = (650 + Math.random()*500) + "ms";
    box.appendChild(piece);
  }
  setTimeout(() => { box.hidden = true; box.innerHTML = ""; }, 950);
}

/* =========================
   Build Flashcards
   ========================= */
function renderFlashcards() {
  const deck = getDeck();
  const host = document.getElementById("flashHost");
  host.innerHTML = "";

  const words = deck.vocab || [];
  const cards = sample(words, DATA.settings.flashcardCount, state.flashSeed);

  cards.forEach(w => {
    let flipped = false;
    const card = el("div", { class:"flashcard" }, [
      el("div", { class:"tag" }, ["Tap to flip"]),
      el("div", { class:"front", style:"direction:ltr; font-size:18px;" }, [w.en]),
      el("div", { class:"back", style:"display:none; font-size:16px;" }, [w.he]),
      el("div", { style:"display:flex; gap:10px; justify-content:center;" }, [ listenBtn(w.en) ])
    ]);

    card.addEventListener("click", (e) => {
      if (e.target && e.target.classList && e.target.classList.contains("listenBtn")) return;
      flipped = !flipped;
      const front = card.querySelector(".front");
      const back = card.querySelector(".back");
      front.style.display = flipped ? "none" : "block";
      back.style.display = flipped ? "block" : "none";
    });

    host.appendChild(card);
  });
}

/* =========================
   Build Game Tasks
   ========================= */
function buildTasks(taskCount) {
  const deck = getDeck();
  const tasks = [];
  const seed = state.seed;

  const vocab = deck.vocab || [];
  const fill = deck.fill || [];
  const yesno = deck.yesno || [];
  const plurals = deck.plurals || [];
  const listeningSets = deck.listeningSets || [];
  const readingSets = deck.readingSets || [];

  // Vocab MCQ (meaning)
  sample(vocab, Math.min(10, vocab.length), seed + 1).forEach(w => {
    const wrong = sample(vocab.filter(x => x.en !== w.en), 3, seed + w.en.length);
    const choices = shuffle([w.he, ...wrong.map(x => x.he)], seed + 11);
    tasks.push({
      type:"mcq",
      mode:"Vocabulary",
      prompt:`××” ×”×¤×™×¨×•×© ×©×œ "${w.en}"?`,
      speakText:w.en,
      sub:"×‘×—×¨/×™ ×¤×™×¨×•×© × ×›×•×Ÿ",
      choices,
      answer:w.he
    });
  });

  // Fill-in
  sample(fill, Math.min(6, fill.length), seed + 2).forEach(q => {
    tasks.push({
      type:"mcq",
      mode:"Fill in",
      prompt: q.template.replace("___","______"),
      speakText: q.template.replace("___", q.answer),
      sub:"×‘×—×¨/×™ ××ª ×”××™×œ×” ×”× ×›×•× ×”",
      choices: q.choices,
      answer: q.answer
    });
  });

  // Yes/No
  sample(yesno, Math.min(6, yesno.length), seed + 3).forEach(q => {
    tasks.push({
      type:"mcq",
      mode:"Yes/No",
      prompt: q.statement,
      speakText: q.statement,
      sub:"×‘×—×¨/×™ Yes ××• No",
      choices:["Yes","No"],
      answer: q.answer ? "Yes" : "No"
    });
  });

  // Plurals (singular/plural both directions)
  sample(plurals, Math.min(7, plurals.length), seed + 4).forEach(p => {
    const wrongP = sample(plurals.filter(x => x.p !== p.p), 3, seed + p.s.length + 40).map(x => x.p);
    tasks.push({
      type:"mcq",
      mode:"Plurals",
      prompt:`What is the plural of "${p.s}"?`,
      speakText: p.s,
      sub:"Choose the correct plural",
      choices: shuffle([p.p, ...wrongP], seed + 401),
      answer: p.p
    });

    const wrongS = sample(plurals.filter(x => x.s !== p.s), 3, seed + p.p.length + 41).map(x => x.s);
    tasks.push({
      type:"mcq",
      mode:"Plurals",
      prompt:`What is the singular of "${p.p}"?`,
      speakText: p.p,
      sub:"Choose the correct singular",
      choices: shuffle([p.s, ...wrongS], seed + 402),
      answer: p.s
    });
  });

  // Listening (always shows text context before question)
  listeningSets.forEach((set, idx) => {
    const qs = sample(set.questions || [], 2, seed + 50 + idx);
    qs.forEach(q => {
      tasks.push({
        type:"mcq",
        mode:"Listening",
        contextTitle: set.title,
        extraText: set.text,         // ×ª××™×“ ××•×¦×’ ×œ×¤× ×™ ×”×©××œ×”
        speakText: set.text,         // ğŸ”Š ××§×¨×™× ××ª ×›×œ ×”×”××–× ×”
        prompt: q.prompt,
        sub:"×œ×—×¥/×™ ğŸ”Š ×›×“×™ ×œ×©××•×¢ ××ª ×”×˜×§×¡×˜, ×•××– ×¢× ×”/×™",
        choices: q.choices,
        answer: q.choices[q.answerIndex]
      });
    });
  });

  // Reading (always shows the reading text before the question)
  readingSets.forEach((set, idx) => {
    const q = sample(set.questions || [], 1, seed + 70 + idx)[0];
    if (!q) return;
    tasks.push({
      type:"mcq",
      mode:"Reading",
      contextTitle: set.title,
      extraText: set.text,          // ×ª××™×“ ××•×¦×’ ×œ×¤× ×™ ×”×©××œ×”
      speakText: set.text,
      prompt: q.prompt,
      sub:"×§×¨×/×™ ××ª ×”×˜×§×¡×˜ (××• ğŸ”Š) ×•××– ×¢× ×”/×™",
      choices: q.choices,
      answer: q.choices[q.answerIndex]
    });
  });

  // Matching (word -> meaning)
  const matchWords = sample(vocab, Math.min(6, vocab.length), seed + 90);
  if (matchWords.length >= 4) {
    const left = shuffle(matchWords.map(w => w.en), seed + 91);
    const right = shuffle(matchWords.map(w => w.he), seed + 92);
    tasks.push({
      type:"match",
      mode:"Matching",
      prompt:"×”×ª×× ××™×œ×” ×œ×¤×™×¨×•×© (×‘×—×¨ ××™×œ×” ×•××– ×¤×™×¨×•×©)",
      sub:"×§×•×“× ××™×œ×” ×‘×× ×’×œ×™×ª ×•××– ×”×¤×™×¨×•×© ×‘×¢×‘×¨×™×ª",
      match: { left, right, pairs: matchWords.map(w => ({en:w.en, he:w.he})) }
    });
  }

  // Ensure at least one reading/listening if requested
  if (DATA.settings.ensureReadingInGame && readingSets.length) {
    const hasReading = tasks.some(t => t.mode === "Reading");
    if (!hasReading) {
      const set = readingSets[0];
      const q = (set.questions || [])[0];
      if (q) tasks.unshift({
        type:"mcq",
        mode:"Reading",
        contextTitle: set.title,
        extraText: set.text,
        speakText: set.text,
        prompt: q.prompt,
        sub:"×§×¨×/×™ ××ª ×”×˜×§×¡×˜ (××• ğŸ”Š) ×•××– ×¢× ×”/×™",
        choices: q.choices,
        answer: q.choices[q.answerIndex]
      });
    }
  }

  if (DATA.settings.ensureListeningInGame && listeningSets.length) {
    const hasListening = tasks.some(t => t.mode === "Listening");
    if (!hasListening) {
      const set = listeningSets[0];
      const q = (set.questions || [])[0];
      if (q) tasks.unshift({
        type:"mcq",
        mode:"Listening",
        contextTitle: set.title,
        extraText: set.text,
        speakText: set.text,
        prompt: q.prompt,
        sub:"×œ×—×¥/×™ ğŸ”Š ×›×“×™ ×œ×©××•×¢ ××ª ×”×˜×§×¡×˜, ×•××– ×¢× ×”/×™",
        choices: q.choices,
        answer: q.choices[q.answerIndex]
      });
    }
  }

  // Final pick
  const final = sample(tasks, taskCount, seed + 999);
  return final;
}

/* =========================
   Render Top
   ========================= */
function renderTop() {
  document.getElementById("score").textContent = String(state.score);
  document.getElementById("streak").textContent = String(state.streak);
  document.getElementById("stars").textContent = String(state.stars);
  document.getElementById("progress").textContent = state.game.tasks.length
    ? `${state.game.index + 1}/${state.game.tasks.length}`
    : "0";
  document.getElementById("modeLabel").textContent = state.game.mode || "â€”";
}

/* =========================
   Render Matching Task
   ========================= */
function renderMatchTask(task) {
  const wrap = el("div", { class:"task" });

  wrap.appendChild(el("div", { class:"prompt" }, [task.prompt]));
  wrap.appendChild(el("div", { class:"sub" }, [task.sub]));

  const info = el("div", { class:"muted" }, ["×˜×™×¤: ××¤×©×¨ ×œ×œ×—×•×¥ ğŸ”Š ×¢×œ ×”××™×œ×” ×‘×× ×’×œ×™×ª."]);
  wrap.appendChild(info);

  const leftHost = el("div", { class:"grid", style:"grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));" });
  const rightHost = el("div", { class:"grid", style:"grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); margin-top:10px;" });

  let selectedEn = null;
  let matched = new Set();
  let correctCount = 0;

  function buttonStyle(btn, active) {
    btn.style.borderColor = active ? "#2563eb" : "#e5e7eb";
    btn.style.background = active ? "#2563eb10" : "#fff";
  }

  task.match.left.forEach(enWord => {
    const btn = el("button", { class:"btn", type:"button" }, [enWord]);
    btn.style.direction = "ltr";
    btn.prepend(listenBtn(enWord));
    btn.onclick = () => {
      selectedEn = enWord;
      [...leftHost.querySelectorAll("button")].forEach(b => buttonStyle(b, b === btn));
    };
    leftHost.appendChild(btn);
  });

  task.match.right.forEach(heWord => {
    const btn = el("button", { class:"btn", type:"button" }, [heWord]);
    btn.onclick = () => {
      if (!selectedEn) {
        wrap.querySelector(".feedback")?.remove();
        wrap.appendChild(feedback("×§×•×“× ×‘×—×¨/×™ ××™×œ×” ×‘×× ×’×œ×™×ª.", false));
        return;
      }
      const pair = task.match.pairs.find(p => p.en === selectedEn);
      const ok = pair && pair.he === heWord;

      wrap.querySelector(".feedback")?.remove();
      if (ok) {
        matched.add(selectedEn);
        correctCount += 1;
        wrap.appendChild(feedback("× ×›×•×Ÿ! âœ…", true));
        // disable both
        [...leftHost.querySelectorAll("button")].forEach(b => {
          if (b.textContent.includes(selectedEn)) b.disabled = true;
        });
        btn.disabled = true;

        selectedEn = null;
        [...leftHost.querySelectorAll("button")].forEach(b => buttonStyle(b, false));

        if (correctCount === task.match.pairs.length) {
          state.score += 1;
          state.streak += 1;
          if (state.streak % 3 === 0) { state.stars += 1; popConfetti(); }
          saveState();
          setTimeout(nextTask, 600);
        }
      } else {
        state.streak = 0;
        saveState();
        wrap.appendChild(feedback("×œ× × ×›×•×Ÿ. × ×¡×”/×™ ×©×•×‘.", false));
      }
    };
    rightHost.appendChild(btn);
  });

  wrap.appendChild(leftHost);
  wrap.appendChild(rightHost);

  wrap.appendChild(el("div", { class:"row", style:"margin-top:10px;" }, [
    el("button", { class:"btn", type:"button", onclick: nextTask }, ["×“×œ×’/×™"])
  ]));

  return wrap;
}

/* =========================
   Render MCQ Task
   ========================= */
function renderMcqTask(task) {
  const wrap = el("div", { class:"task" });

  wrap.appendChild(el("div", { class:"row" }, [
    el("div", {}, [
      el("div", { class:"prompt" }, [task.prompt]),
      el("div", { class:"sub" }, [task.sub || ""])
    ]),
    el("div", { style:"display:flex; gap:10px; justify-content:flex-start; flex-wrap:wrap;" }, [
      listenBtn(task.speakText || task.prompt),
      task.extraText ? el("button", { class:"btn", type:"button", onclick: () => speak(task.extraText) }, ["ğŸ”Š ×›×œ ×”×˜×§×¡×˜"]) : el("span", { class:"muted" }, [""])
    ])
  ]));

  // Always show context text BEFORE questions when present
  if (task.extraText) {
    wrap.appendChild(el("div", { class:"readingBox" }, [task.extraText]));
  }

  const answers = el("div", { class:"answers" });
  const name = "q_" + state.game.index + "_" + Math.random().toString(16).slice(2);

  (task.choices || []).forEach(ch => {
    answers.appendChild(
      el("label", {}, [
        el("input", { type:"radio", name, value: ch }),
        ch
      ])
    );
  });

  wrap.appendChild(answers);

  const btnRow = el("div", { class:"row" }, [
    el("button", { class:"btn primary", type:"button" }, ["×‘×“×™×§×”"]),
    el("button", { class:"btn", type:"button" }, ["×“×œ×’/×™"])
  ]);

  const checkBtn = btnRow.children[0];
  const skipBtn  = btnRow.children[1];

  checkBtn.onclick = () => {
    wrap.querySelector(".feedback")?.remove();
    const chosen = wrap.querySelector(`input[name="${name}"]:checked`);
    if (!chosen) { wrap.appendChild(feedback("×‘×—×¨/×™ ×ª×©×•×‘×” ×§×•×“×.", false)); return; }

    const ok = chosen.value === task.answer;
    if (ok) {
      state.score += 1;
      state.streak += 1;
      if (state.streak % 3 === 0) { state.stars += 1; popConfetti(); }
      wrap.appendChild(feedback("× ×›×•×Ÿ! âœ…", true));
    } else {
      state.streak = 0;
      wrap.appendChild(feedback(`×œ×. ×”×ª×©×•×‘×”: ${task.answer}`, false));
    }
    saveState();
    setTimeout(nextTask, 700);
  };

  skipBtn.onclick = () => {
    state.streak = 0;
    saveState();
    nextTask();
  };

  wrap.appendChild(btnRow);
  return wrap;
}

/* =========================
   Game Flow
   ========================= */
function startGame() {
  const taskCount = Math.max(6, Math.min(30, Number(document.getElementById("taskCount").value || 14)));
  state.seed = Date.now();
  state.game.tasks = buildTasks(taskCount);
  state.game.index = 0;
  state.game.mode = state.game.tasks[0]?.mode || "â€”";
  saveState();
  renderGame();
  window.scrollTo({ top: document.getElementById("gameArea").offsetTop - 10, behavior:"smooth" });
}

function nextTask() {
  if (!state.game.tasks.length) return;
  if (state.game.index < state.game.tasks.length - 1) {
    state.game.index += 1;
    state.game.mode = state.game.tasks[state.game.index]?.mode || "â€”";
    saveState();
    renderGame();
    window.scrollTo({ top: document.getElementById("gameArea").offsetTop - 10, behavior:"smooth" });
  } else {
    endGame();
  }
}

function endGame() {
  const host = document.getElementById("taskHost");
  host.innerHTML = "";

  host.appendChild(
    el("div", { class:"card", style:"background:#111827; border-color:#111827; color:#fff;" }, [
      el("div", { class:"bigTitle" }, [
        el("h2", {}, ["×¡×™×™××ª! ğŸ‰"]),
        el("p", { class:"muted", style:"color:#cbd5e1;" }, ["×¨×¢× ×•×Ÿ ×•××– ×¢×•×“ ×¡×™×‘×•×‘"])
      ]),
      el("div", { class:"hr", style:"background:#334155;" }),
      el("div", { class:"row" }, [
        el("span", { class:"pill" }, [el("b", {}, ["× ×™×§×•×“"]), " " + state.score]),
        el("span", { class:"pill" }, [el("b", {}, ["×›×•×›×‘×™×"]), " " + state.stars + " â­"]),
        el("span", { class:"pill" }, [el("b", {}, ["×¨×¦×£"]), " " + state.streak]),
      ]),
      el("div", { style:"margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;" }, [
        el("button", { class:"btn warn", type:"button", onclick: startGame }, ["×¢×•×“ ××©×—×§"]),
        el("button", { class:"btn", type:"button", onclick: () => { state.flashSeed = Date.now(); renderFlashcards(); saveState(); } }, ["×›×¨×˜×™×¡×™×•×ª ×—×“×©×•×ª"]),
      ])
    ])
  );

  popConfetti();
  state.game.tasks = [];
  state.game.index = 0;
  state.game.mode = "â€”";
  saveState();
}

function renderGame() {
  const host = document.getElementById("taskHost");
  host.innerHTML = "";
  if (!state.game.tasks.length) {
    host.appendChild(el("div", { class:"muted" }, ["×œ×—×¦×• '×”×ª×—×œ ××©×—×§' ×›×“×™ ×œ×”×ª×—×™×œ."]));
    renderTop();
    return;
  }

  const task = state.game.tasks[state.game.index];
  state.game.mode = task.mode || "â€”";

  if (task.type === "match") host.appendChild(renderMatchTask(task));
  else host.appendChild(renderMcqTask(task));

  renderTop();
}

/* =========================
   UI init
   ========================= */
function renderDeckSelect() {
  const sel = document.getElementById("deckSelect");
  sel.innerHTML = "";
  DATA.decks.forEach(d => {
    const opt = document.createElement("option");
    opt.value = d.id;
    opt.textContent = d.name;
    sel.appendChild(opt);
  });
  sel.value = state.deckId;
  sel.onchange = () => {
    state.deckId = sel.value;
    state.seed = Date.now();
    state.flashSeed = Date.now();
    state.game.tasks = [];
    state.game.index = 0;
    state.game.mode = "â€”";
    saveState();
    renderFlashcards();
    renderGame();
  };
}

loadState();
renderDeckSelect();
renderFlashcards();
renderGame();
renderTop();

document.getElementById("startBtn").onclick = startGame;
document.getElementById("refreshBtn").onclick = () => {
  state.seed = Date.now();
  state.game.tasks = [];
  state.game.index = 0;
  state.game.mode = "â€”";
  saveState();
  renderFlashcards();
  renderGame();
};
document.getElementById("newCardsBtn").onclick = () => {
  state.flashSeed = Date.now();
  saveState();
  renderFlashcards();
};
document.getElementById("resetBtn").onclick = () => {
  if (!confirm("×œ××¤×¡ × ×™×§×•×“, ×¨×¦×£ ×•×›×•×›×‘×™×?")) return;
  state.score = 0; state.streak = 0; state.stars = 0;
  saveState();
  renderTop();
};
</script>
</body>
</html>
